<html>
	<head>
		<style type="text/css">
            #game {
                border: 1px solid black;
            }
        </style>
	</head>
	<body>
        <div id="game"></div>
        <script type="text/javascript" src="js/crafty.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>
        <script>
        	var viewWidth = 600,
                viewHeight = 600;


			Crafty.init(viewWidth, viewHeight, document.getElementById('game'));  

            var past1stScreen = false          

            Crafty.scene("1stScreen", function() {

                var ATTACK_DIRECTIONS = {
                    LEFT: "LEFT",
                    RIGHT: "RIGHT",
                    UP: "UP",
                    DOWN: "DOWN"
                }

    			//Walls
                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 0, y: 0, w: 1, h: viewHeight})
                    .color('#F00')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 599, y: 0, w: 1, h: viewHeight})
                    .color('#F00')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 0, y: 0, w: viewWidth/2 - 30, h: 1})
                    .color('#F00')
                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: viewWidth/2 + 30, y: 0, w: viewWidth/2 - 30, h: 1})
                    .color('#F00')


                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 0, y: 599, w: viewWidth, h: 1})
                    .color('#F00')


                //Terrain
                /*Crafty.e('2D, DOM, Solid, Color')
                	.attr({x: 50, y: 450, w: 70, h: 40})
                	.color('#f4a460')

                Crafty.e('2D, DOM, Solid, Color')
                	.attr({x: 120, y: 200, w: 80, h: 90})
                	.color('#f4a460')

                Crafty.e('2D, DOM, Solid, Color')
                	.attr({x: 350, y: 40, w: 30, h: 60})
                	.color('#f4a460')

                Crafty.e('2D, DOM, Solid, Color')
                	.attr({x: 500, y: 400, w: 50, h: 50})
                	.color('#f4a460')*/


                

                //PC component
            	Crafty.c('PlayerCharacter', {
                    init: function() {
                        this.requires('2D, DOM, Player, Collision, Fourway, Solid, Color')
                            .attr({w: 30, h: 30})
                            .fourway(300)
                            .color('#000000')
                            .stopOnSolids()
                            .attackOnSpace()
                            .hitByAttack()

                        this.hp = 5
                        this._attackDirection = ATTACK_DIRECTIONS.DOWN;

                        this.bind('Moved', function(movement) {
                            if (movement.axis == "x") {
                                if (this.x - movement.oldValue < 0) {
                                    this._attackDirection = ATTACK_DIRECTIONS.LEFT;
                                } else {
                                    this._attackDirection = ATTACK_DIRECTIONS.RIGHT;
                                }
                            } else {
                                if (this.y - movement.oldValue < 0) {
                                    this._attackDirection = ATTACK_DIRECTIONS.UP;
                                } else {
                                    this._attackDirection = ATTACK_DIRECTIONS.DOWN;
                                }
                            };
                        });
           	        },
           	        stopOnSolids: function() {
                        this.onHit('Solid', this.stopMovement);
                        return this;
                    },
                    stopMovement: function(hit_vals) {
                        this.x -= this.dx;
                        this.y -= this.dy;
                    },
                    attackOnSpace: function() {
                        var hero = this;
                        this.bind('KeyDown', function(e) {
                            if (e.key == Crafty.keys.SPACE) {
                                var attack = Crafty.e('PlayerAttack');
                                switch(hero._attackDirection) {
                                    case ATTACK_DIRECTIONS.RIGHT:
                                        attack.attr({x: hero.x + 30, y: hero.y})
                                        break;
                                    case ATTACK_DIRECTIONS.LEFT:
                                        attack.attr({x: hero.x - 30, y: hero.y})
                                        break;
                                    case ATTACK_DIRECTIONS.UP:
                                        attack.attr({x: hero.x, y: hero.y - 30})
                                        break;
                                    case ATTACK_DIRECTIONS.DOWN:
                                        attack.attr({x: hero.x, y: hero.y + 30})
                                        break;
                                }
                            }
                        	setTimeout(function() {Crafty('PlayerAttack').destroy()}, 50)
                        });
                        return this;
                    },
                    hitByAttack: function() {
                        this.checkHits('EAttack')
                        .bind('HitOn', function() {
                            console.log("hit!")
                            console.log(arguments);
                            this.hp--;
                            console.log("remaining hp", this.hp)
                            if (this.hp <= 0) {
                                this.destroy();
                                Crafty.stop();
                                alert('You Lose!')
                            }
                        })
                        return this;
                    },
                }),

                Crafty.c('PlayerAttack', {
                	init: function() {
                		this.requires('2D, DOM, PAttack, Collision, Color')
                			.attr({w: 30, h: 30})
                			.color('#ff0000')
                	}
                });

                Crafty.c('Enemy', {
                	init: function() {
                		this.requires('2D, DOM, Enemy, Collision, Solid, Motion, Color')
                			.color('#d3d3d3')
                			.attr({w:30, h: 30})
                			.stopOnSolids()
                			.hitByAttack();

                        this._rightHitbox = Crafty.e('EnemyHitbox').attr({x: this.x + 30, y: this.y});
                        this._leftHitbox = Crafty.e('EnemyHitbox').attr({x: this.x - 30, y: this.y});
                        this._upHitbox = Crafty.e('EnemyHitbox').attr({x: this.x, y: this.y + 30});
                        this._downHitbox = Crafty.e('EnemyHitbox').attr({x: this.x, y: this.y - 30});

                        this.attach(this._rightHitbox, this._leftHitbox, this._upHitbox, this._downHitbox);

                        this.combat();

                        this.hp = 3;
                        this._attackDirection = ATTACK_DIRECTIONS.DOWN;
                	},
                	stopOnSolids: function() {
                        this.onHit('Solid', this.stopMovement);
                        return this;
                    },
                    stopMovement: function(hit_vals) {
                        this.x -= this.dx;
                        this.y -= this.dy;
                    },
                    hitByAttack: function() {
                    	this.checkHits('PAttack')
                        .bind('HitOn', function() {
                            console.log("hit!")
                            this.hp--;
                            console.log("remaining hp", this.hp)
                            if (this.hp <= 0) {
                                this.destroy();
                            }
                        })
                        return this;
                    },
                    //Not Working ATM
                    combat: function() {
                        var enemy = this;

                        var createAttackOnHit = function(direction, x, y) {
                            return function() {
                                enemy._attackDirection = direction;
                            
                                setTimeout(function() {
                                    enemy.velocity().x = 0
                                    enemy.velocity().y = 0
                                }, 100)


                                setTimeout (function() {
                                    var attack = Crafty.e('EnemyAttack').attr({x: enemy.x + x, y: enemy.y + y});
                                    setTimeout(function() {attack.destroy()}, 100);
                                    enemy.velocity().x = 1
                                }, 200);
                            }
                        }

                        this._leftHitbox.checkHits('Player')
                            .bind('HitOn', createAttackOnHit(ATTACK_DIRECTIONS.LEFT, -30, 0));
                        this._rightHitbox.checkHits('Player')
                            .bind('HitOn', createAttackOnHit(ATTACK_DIRECTIONS.RIGHT, 30, 0));
                        this._upHitbox.checkHits('Player')
                            .bind('HitOn', createAttackOnHit(ATTACK_DIRECTIONS.UP, 0, 30));
                        this._downHitbox.checkHits('Player')
                            .bind('HitOn', createAttackOnHit(ATTACK_DIRECTIONS.DOWN, 0, -30));

                        enemy.bind('Moved', function(movement) {
                            var x_distance = Math.abs(enemy.x - Crafty('PlayerCharacter').x);
                            var y_distance = Math.abs(enemy.y - Crafty('PlayerCharacter').y);

                            if (enemy.x > Crafty('PlayerCharacter').x) {
                                enemy.velocity().x = -300
                            }
                            if (enemy.x < Crafty('PlayerCharacter').x) {
                                enemy.velocity().x = 300
                            } 
                            if (x_distance < 5) {
                                enemy.velocity().x = 0
                            }
                            if (enemy.y > Crafty('PlayerCharacter').y) {
                                enemy.velocity().y = -300
                            }
                            if (enemy.y < Crafty('PlayerCharacter').y) {
                                enemy.velocity().y = 300
                            } 
                            if (y_distance < 5) {
                                enemy.velocity().y = 0
                            }

                        })
                    }
                });

                
                Crafty.c('EnemyHitbox', {
                    init: function() {
                        this.requires('2D, DOM, Collision, eAttackHitbox, Color')
                        .attr({ w: 30, h: 30})
                    }
                })

                Crafty.c('EnemyAttack', {
                    init: function() {
                        this.requires('2D, DOM, EAttack, Color')
                            .attr({ w: 30, h: 30})
                            .color('yellow')

                        console.log('EnemyAttack object created')
                    }
                });

                var enemies = [];

                if (past1stScreen == true) {
                    Crafty.e('PlayerCharacter').attr({x:newScreenSpawn, y: 1});
                }
                else {
                    Crafty.e('PlayerCharacter').attr({x: 285, y:285});
                }
                /*enemies.push(
                    Crafty.e('Enemy')
                        .attr({x: 5, y: 5})
                )

                enemies.push(
                    Crafty.e('Enemy')
                        .attr({x: 300, y: 400})
                )
                enemies.push(
                    Crafty.e('Enemy')
                        .attr({x: 100, y: 565})
                )*/

                for (var i = 0; i < enemies.length; i++) {
                    enemies[i].velocity().x = 1;
                }
            })
            
            Crafty.scene('1stScreen')

            Crafty.scene('2ndScreen', function() {

                //Walls
                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 0, y: 0, w: 1, h: viewHeight})
                    .color('#F00')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 599, y: 0, w: 1, h: viewHeight})
                    .color('#F00')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 0, y: 599, w: viewWidth/2 - 30, h: 1})
                    .color('#F00')
                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: viewWidth/2 + 30, y: 599, w: viewWidth/2 - 30, h: 1})
                    .color('#F00')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 0, y: 0, w: viewWidth, h: 1})
                    .color('#F00')

                //Terrain
                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 50, y: 450, w: 70, h: 40})
                    .color('#f4a460')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 120, y: 200, w: 80, h: 90})
                    .color('#f4a460')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 350, y: 40, w: 30, h: 60})
                    .color('#f4a460')

                Crafty.e('2D, DOM, Solid, Color')
                    .attr({x: 500, y: 400, w: 50, h: 50})
                    .color('#f4a460')

                Crafty.e('PlayerCharacter')
                    .attr({x:newScreenSpawn, y: viewHeight - 30})


                var enemies = [];

                enemies.push(
                    Crafty.e('Enemy')
                        .attr({x: 5, y: 5})
                )
                enemies.push(
                    Crafty.e('Enemy')
                        .attr({x: 300, y: 400})
                )
                enemies.push(
                    Crafty.e('Enemy')
                        .attr({x: 100, y: 565})
                )

                for (var i = 0; i < enemies.length; i++) {
                    enemies[i].velocity().x = 1;
                }

            })
            
            var newScreenSpawn = 0

            setTimeout(function() {
                setInterval(function() {
                    if (Crafty('PlayerCharacter').y < 0) {
                        newScreenSpawn = Crafty('PlayerCharacter').x
                        Crafty.scene('2ndScreen')
                        past1stScreen = true
                    }
                    if (Crafty('PlayerCharacter').y > viewHeight - 30) {
                        newScreenSpawn = Crafty('PlayerCharacter').x

                        Crafty.scene('1stScreen')
                    }
                }, 50)
            }, 2000)
            
        </script>

    </body>

</html>
